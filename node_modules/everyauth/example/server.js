var connect = require('connect')
  , everyauth = require('../index');


var usersByFbId = {};
var usersByLogin = {
  'brian': {
      login: 'brian'
    , password: 'password'
  }
};

// "appId":"138287049533135",
// "key":"2cd15c27435165a18e740096fbbbe637",
// "secret":"25aa86a1dea93a702e91291286ad4838"
everyauth
  .facebook
    .myHostname('http://local.host:3000')
    .appId('138287049533135')
    .appSecret('25aa86a1dea93a702e91291286ad4838')
    .findOrCreateUser( function (session, accessToken, fbUserMetadata) {
      return usersByFbId[fbUserMetadata.id] ||
        (usersByFbId[fbUserMetadata.id] = fbUserMetadata);
    })
    .redirectPath('/');

everyauth
  .password
    .getLoginPath('/login')
    .postLoginPath('/login')
    .loginView('<html>                                              \n\
          <head>                                             \n\
            <title>everyauth -- Not Authenticated</title> \n\
          </head>                                            \n\
          <body>                                             \n\
            <form action="/login" method="POST"> \n\
              <div> \n\
                <label for="login">Login</label> \n\
                <input type="text" name="login" /> \n\
              </div> \n\
              <div> \n\
                <label for="password">Password</label> \n\
                <input type="password" name="password" /> \n\
              </div> \n\
              <input type="submit">Login</input> \n\
            </form> \n\
          </body>                                            \n\
        </html>'
    )
    .redirectPath('/')
    .findUser( function (didSucceed, login) {
      return didSucceed && usersByLogin[login];
    })
    .authenticate( function (login, password) {
      var user = usersByLogin[login];
      if (!user) return false;
      return user.password === password;
    });

var routes = function (app) {
  app.get('/logout', function (req, res) {
    req.logout();
    res.writeHead(303, { Location: '/'});
    res.end();
  });
  app.get('/', function(req, res, params) {
    var self=this;
    res.writeHead(200, {'Content-Type': 'text/html'})
    if( !req.loggedIn ) {
      res.end('<html>                                              \n\
          <head>                                             \n\
            <title>everyauth -- Not Authenticated</title> \n\
            <script src="http://static.ak.fbcdn.net/connect/en_US/core.js"></script> \n\
          </head>                                            \n\
          <body>                                             \n\
            <div id="wrapper">                               \n\
              <h1>Not authenticated</h1>                     \n\
              <div style="float:left;margin-left:5px">       \n\
                <a href="/login" style="border:0px">  \n\
                  Password Authentication              \n\
                </a>                                         \n\
              </div>                                         \n\
              <div class="fb_button" id="fb-login" style="float:left; background-position: left -188px">          \n\
                <a href="/auth/facebook" class="fb_button_medium">        \n\
                  <span id="fb_login_text" class="fb_button_text"> \n\
                    Connect with Facebook                    \n\
                  </span>                                    \n\
                </a>                                         \n\
              </div>                                         \n\
              <!--                                           \n\
              <div style="float:left;margin-left:5px">       \n\
                <a href="/auth/yahoo" style="border:0px">  \n\
                 <img style="border:0px" src="http://l.yimg.com/a/i/reg/openid/buttons/1_new.png"/> \n\
                </a>                                         \n\
              </div>                                         \n\
              <div style="float:left;margin-left:5px"> \n\
                <button onclick="location.href=\'/auth/google\'" style="padding:5px;border-radius:5px;border:1px solid #555555;cursor:pointer"> \n\
                  <img src="https://www.google.com/favicon.ico" style="margin-bottom:-3px;"><span style="font-weight:bold;">&nbsp; Sign In with Google \n\
                </button> \n\
              </div> \n\
              <div style="float:left;margin-left:5px">       \n\
                <a href="/auth/twitter" style="border:0px">  \n\
                  <img style="border:0px" src="http://apiwiki.twitter.com/f/1242697715/Sign-in-with-Twitter-darker.png"/>\n\
                </a>                                         \n\
              </div>                                         \n\
              <div style="float:left;margin-left:5px">       \n\
                <a href="/auth/github" style="border:0px">  \n\
                  <img style="border:0px" src="http://github.com/intridea/authbuttons/raw/master/png/github_64.png"/>\n\
                </a>                                         \n\
              </div>                                         \n\
              <div style="float:left;margin-left:5px">       \n\
                <a href="/auth/foursquare" style="border:0px">  \n\
                  FourSquare\n\
                </a>                                         \n\
              </div>                                         \n\
              -->                                            \n\
            </div>                                           \n\
          </body>                                            \n\
        </html>')
    }
    else {
      res.end('<html>                                              \n\
          <head>                                             \n\
            <title>Express Auth -- Authenticated</title>\n\
          </head>                                            \n\
          <body>                                             \n\
            <div id="wrapper">                               \n\
              <h1>Authenticated</h1>     \n\
            ' + (req.session.auth.facebook 
                 ? JSON.stringify( req.session.auth.facebook.user) 
                 : ''
                ) + '   \n\
             <h2><a href="/logout">Logout</a></h2>                \n\
            </div>                                           \n\
          </body>                                            \n\
        </html>')
    }
  });
};

var app = connect(
    connect.bodyParser()
  , connect.cookieParser()
  , connect.session({secret: 'mr ripley'})
  , everyauth.middleware()
  , connect.router(routes)
);

app.listen(3000);
